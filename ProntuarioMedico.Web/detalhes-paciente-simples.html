<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Paciente - Sistema de Prontuários</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fas fa-heartbeat me-2"></i>
                Sistema de Prontuários
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-bars"></i> Menu
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="index.html"><i class="fas fa-home me-2"></i>Início</a></li>
                            <li><a class="dropdown-item active" href="pacientes.html"><i class="fas fa-users me-2"></i>Pacientes</a></li>
                            <li><a class="dropdown-item" href="estatisticas-simples.html"><i class="fas fa-chart-bar me-2"></i>Estatísticas</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="Auth.logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div id="content">
            <h2>Carregando dados do paciente...</h2>
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
    </div>

    <script>
        async function loadPatient() {
            try {
                console.log('Iniciando carregamento...');
                
                // Get patient ID from URL
                const urlParams = new URLSearchParams(window.location.search);
                const patientId = urlParams.get('id');
                
                console.log('Patient ID:', patientId);
                
                if (!patientId) {
                    throw new Error('ID do paciente não encontrado na URL');
                }
                
                // Garantir que o ID seja um número válido
                if (isNaN(parseInt(patientId))) {
                    throw new Error('ID do paciente inválido');
                }
                
                console.log('Fazendo requisição para API...');
                // Adicionar um timestamp para evitar cache
                const timestamp = new Date().getTime();
                const response = await fetch(`http://localhost:5135/api/pacientes/${patientId}?_=${timestamp}`);
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                console.log('Parsing JSON...');
                const patient = await response.json();
                
                console.log('Patient data:', patient);
                
                // Format date
                const formatDate = (dateString) => {
                    if (!dateString) return '';
                    const date = new Date(dateString);
                    return date.toLocaleDateString('pt-BR');
                };
                
                console.log('Rendering HTML...');
                
                document.getElementById('content').innerHTML = `
                    <div class="row">
                        <div class="col-12">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h2><i class="fas fa-user-circle"></i> ${patient.nome}</h2>
                                <div>
                                    <a href="pacientes.html" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left"></i> Voltar
                                    </a>
                                    <a href="editar-paciente-simples.html?id=${patient.id}" class="btn btn-warning">
                                        <i class="fas fa-edit"></i> Editar
                                    </a>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Dados Pessoais</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Nome:</strong> ${patient.nome}</p>
                                            <p><strong>Idade:</strong> ${patient.idade} anos</p>
                                            <p><strong>Data de Nascimento:</strong> ${formatDate(patient.dataNascimento)}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Endereço:</strong></p>
                                            <p><strong>CEP:</strong> ${patient.cep || 'Não informado'}</p>
                                            <p>${patient.rua}, ${patient.numero}${patient.complemento ? ' - ' + patient.complemento : ''}</p>
                                            <p>${patient.bairro} - ${patient.cidade}/${patient.estado}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Seção de Prontuários Médicos -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="fas fa-file-medical me-2"></i>
                                        Prontuários Médicos
                                    </h5>
                                    <button type="button" class="btn btn-primary btn-sm" onclick="criarNovoProntuario()">
                                        <i class="fas fa-plus me-1"></i>
                                        Novo Prontuário
                                    </button>
                                </div>
                                <div class="card-body">
                                    <!-- Contador de prontuários -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div>
                                            <span id="contadorProntuarios" class="text-muted">
                                                <i class="fas fa-spinner fa-spin me-1"></i>
                                                Carregando prontuários...
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- Tabela de prontuários -->
                                    <div id="tabelaProntuarios" class="table-responsive">
                                        <table class="table table-hover">
                                            <thead class="table-dark">
                                                <tr>
                                                    <th>Data de Registro</th>
                                                    <th>Pressão Arterial</th>
                                                    <th>Ausculta</th>
                                                    <th>Observações</th>
                                                    <th width="150">Ações</th>
                                                </tr>
                                            </thead>
                                            <tbody id="corpoProntuarios">
                                                <!-- Linhas serão inseridas aqui pelo JavaScript -->
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- Mensagem quando não há prontuários -->
                                    <div id="semProntuarios" class="text-center py-5 d-none">
                                        <i class="fas fa-file-medical fa-4x text-muted mb-3"></i>
                                        <h5 class="text-muted">Nenhum prontuário encontrado</h5>
                                        <p class="text-muted">Comece criando um novo prontuário médico para este paciente.</p>
                                        <button type="button" class="btn btn-primary" onclick="criarNovoProntuario()">
                                            <i class="fas fa-plus me-1"></i>
                                            Criar Primeiro Prontuário
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                console.log('HTML renderizado com sucesso!');
                
                // Carregar prontuários do paciente
                await loadProntuarios(patient.id);
                
            } catch (error) {
                console.error('Erro:', error);
                
                document.getElementById('content').innerHTML = `
                    <div class="alert alert-danger">
                        <h4>Erro ao carregar paciente</h4>
                        <p>${error.message}</p>
                        <a href="pacientes.html" class="btn btn-secondary">Voltar à Lista</a>
                    </div>
                `;
            }
        }
        
        // Função para carregar prontuários do paciente
        async function loadProntuarios(pacienteId) {
            try {
                console.log('Carregando prontuários para paciente:', pacienteId);
                
                const response = await fetch(`http://localhost:5135/api/prontuarios/paciente/${pacienteId}`);
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                const prontuarios = await response.json();
                console.log('Prontuários carregados:', prontuarios);
                
                // Atualizar contador
                const contador = document.getElementById('contadorProntuarios');
                contador.innerHTML = `
                    <i class="fas fa-file-medical me-1"></i>
                    Mostrando ${prontuarios.length} prontuário${prontuarios.length !== 1 ? 's' : ''}
                `;
                
                // Renderizar tabela ou mensagem vazia
                if (prontuarios.length > 0) {
                    renderProntuarios(prontuarios);
                    document.getElementById('tabelaProntuarios').classList.remove('d-none');
                    document.getElementById('semProntuarios').classList.add('d-none');
                } else {
                    document.getElementById('tabelaProntuarios').classList.add('d-none');
                    document.getElementById('semProntuarios').classList.remove('d-none');
                }
                
            } catch (error) {
                console.error('Erro ao carregar prontuários:', error);
                document.getElementById('contadorProntuarios').innerHTML = `
                    <i class="fas fa-exclamation-triangle me-1 text-warning"></i>
                    Erro ao carregar prontuários
                `;
            }
        }
        
        // Função para renderizar prontuários na tabela
        function renderProntuarios(prontuarios) {
            const tbody = document.getElementById('corpoProntuarios');
            tbody.innerHTML = '';
            
            prontuarios.forEach(prontuario => {
                const row = `
                    <tr>
                        <td>${formatDate(prontuario.dataCriacao)}</td>
                        <td>${prontuario.pressao || 'Não informado'}</td>
                        <td>${prontuario.ausculta || 'Não informado'}</td>
                        <td>${prontuario.observacoes ? (prontuario.observacoes.length > 50 ? prontuario.observacoes.substring(0, 50) + '...' : prontuario.observacoes) : 'Não informado'}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-outline-info btn-sm" 
                                        onclick="visualizarProntuario(${prontuario.id})" 
                                        title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button type="button" class="btn btn-outline-warning btn-sm" 
                                        onclick="editarProntuario(${prontuario.id})" 
                                        title="Editar">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        onclick="deletarProntuario(${prontuario.id})" 
                                        title="Deletar">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }
        
        // Função para criar novo prontuário
        function criarNovoProntuario() {
            const urlParams = new URLSearchParams(window.location.search);
            const pacienteId = urlParams.get('id');
            window.location.href = `criar-prontuario.html?pacienteId=${pacienteId}`;
        }
        
        // Função para visualizar prontuário
        function visualizarProntuario(prontuarioId) {
            window.location.href = `detalhes-prontuario.html?id=${prontuarioId}`;
        }
        
        // Função para editar prontuário
        function editarProntuario(prontuarioId) {
            window.location.href = `editar-prontuario.html?id=${prontuarioId}&voltarPara=paciente`;
        }
        
        // Função para deletar prontuário
        async function deletarProntuario(prontuarioId) {
            if (!confirm('Tem certeza que deseja deletar este prontuário? Esta ação não pode ser desfeita.')) {
                return;
            }
            
            try {
                const response = await fetch(`http://localhost:5135/api/prontuarios/${prontuarioId}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
                // Recarregar lista de prontuários
                const urlParams = new URLSearchParams(window.location.search);
                const pacienteId = urlParams.get('id');
                await loadProntuarios(pacienteId);
                
                // Mostrar mensagem de sucesso
                alert('Prontuário deletado com sucesso!');
                
            } catch (error) {
                console.error('Erro ao deletar prontuário:', error);
                alert('Erro ao deletar prontuário. Tente novamente.');
            }
        }
        
        // Função para formatar data
        function formatDate(dateString) {
            if (!dateString) return 'Data não informada';
            
            const date = new Date(dateString);
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            };
            
            return date.toLocaleDateString('pt-BR', options);
        }
        
        // Load when page is ready
        document.addEventListener('DOMContentLoaded', loadPatient);
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Auth JS -->
    <script src="js/auth.js"></script>
    <script>
        // Inicializar autenticação antes de carregar dados
        document.addEventListener('DOMContentLoaded', function() {
            Auth.initialize();
            
            // Aguardar um pouco para garantir que o DOM está totalmente carregado
            setTimeout(() => {
                Auth.updateLogoutButtons();
            }, 100);
        });
    </script>
</body>
</html>